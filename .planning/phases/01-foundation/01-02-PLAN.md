---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/popup/popup.html
  - src/popup/popup.js
  - src/popup/popup.css
autonomous: false

must_haves:
  truths:
    - "Webhook URL field accepts and saves a URL string (SETT-01)"
    - "Schedule interval dropdown saves the selected value (SETT-02)"
    - "Output format radio buttons save the selected value (SETT-03)"
    - "Notification toggles (master + per-type) save their checked state (SETT-04)"
    - "Saved settings persist across popup close/reopen (stored in chrome.storage.local)"
    - "Defaults are applied when no settings have been saved yet"
    - "All settings inputs are pre-filled from storage when popup opens"
  artifacts:
    - path: "src/popup/popup.html"
      provides: "Settings form with all four setting groups"
      contains: "webhook-url, schedule-interval, output-format, notification toggles"
    - path: "src/popup/popup.js"
      provides: "Storage read/write logic for all settings"
      exports: ["loadSettings", "saveSettings"]
    - path: "src/popup/popup.css"
      provides: "Clean form styling"
  key_links:
    - from: "src/popup/popup.js"
      to: "chrome.storage.local"
      via: "chrome.storage.local.get / set"
      pattern: "chrome\\.storage\\.local\\.(get|set)"
    - from: "src/popup/popup.html"
      to: "src/popup/popup.js"
      via: "<script src> at bottom of body"
      pattern: "script src=\"popup.js\""
    - from: "src/popup/popup.html"
      to: "src/popup/popup.css"
      via: "<link rel=stylesheet>"
      pattern: "link rel=\"stylesheet\" href=\"popup.css\""
---

<objective>
Build the settings popup: a functional HTML form that reads from and writes to chrome.storage.local, covering all four setting requirements (SETT-01 through SETT-04).

Purpose: This is the only user-facing control surface for the extension. All future phases (scheduling, scraping, webhook dispatch) read their config from the storage values set here.
Output: popup.html + popup.js + popup.css — a fully wired settings UI that persists user preferences.
</objective>

<execution_context>
@C:/Users/Glorvax/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-01-SUMMARY.md

Settings storage key schema (define once here, all future phases read these exact keys):
  - webhookUrl: string (default: "")
  - scheduleInterval: number in minutes (default: 30, options: 15/30/60/120)
  - outputFormat: string enum (default: "both", options: "webhook"/"csv"/"both")
  - notifications.master: boolean (default: true)
  - notifications.scrapeComplete: boolean (default: true)
  - notifications.webhookSent: boolean (default: true)
  - notifications.proposalLoaded: boolean (default: true)
  - notifications.errors: boolean (default: true)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build popup.html form and popup.css styling</name>
  <files>
    src/popup/popup.html
    src/popup/popup.css
  </files>
  <action>
    Replace the placeholder popup.html (from plan 01-01) with the full settings form. Create popup.css alongside it.

    --- src/popup/popup.html ---
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Upwork Job Scraper</title>
      <link rel="stylesheet" href="popup.css">
    </head>
    <body>
      <div id="app">
        <header>
          <h1>Upwork Job Scraper</h1>
        </header>

        <main>
          <!-- SETT-01: Webhook URL -->
          <section class="setting-group">
            <label for="webhook-url">Webhook URL</label>
            <input
              type="url"
              id="webhook-url"
              name="webhookUrl"
              placeholder="https://your-n8n-instance.com/webhook/..."
              autocomplete="off"
              spellcheck="false"
            >
            <p class="hint">n8n webhook endpoint that receives job data.</p>
          </section>

          <!-- SETT-02: Schedule interval -->
          <section class="setting-group">
            <label for="schedule-interval">Check Interval</label>
            <select id="schedule-interval" name="scheduleInterval">
              <option value="15">Every 15 minutes</option>
              <option value="30" selected>Every 30 minutes</option>
              <option value="60">Every 60 minutes</option>
              <option value="120">Every 2 hours</option>
            </select>
          </section>

          <!-- SETT-03: Output format -->
          <section class="setting-group">
            <span class="label">Output Format</span>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="outputFormat" value="webhook"> Webhook only
              </label>
              <label class="radio-label">
                <input type="radio" name="outputFormat" value="csv"> CSV only
              </label>
              <label class="radio-label">
                <input type="radio" name="outputFormat" value="both" checked> Both
              </label>
            </div>
          </section>

          <!-- SETT-04: Notification toggles -->
          <section class="setting-group">
            <span class="label">Notifications</span>
            <div class="toggle-row master-toggle-row">
              <label class="toggle-label" for="notif-master">
                <input type="checkbox" id="notif-master" name="notifMaster" checked>
                Enable notifications
              </label>
            </div>
            <div id="notif-subtypes" class="notif-subtypes">
              <label class="toggle-label sub">
                <input type="checkbox" id="notif-scrape-complete" name="notifScrapeComplete" checked>
                Scrape complete
              </label>
              <label class="toggle-label sub">
                <input type="checkbox" id="notif-webhook-sent" name="notifWebhookSent" checked>
                Webhook sent
              </label>
              <label class="toggle-label sub">
                <input type="checkbox" id="notif-proposal-loaded" name="notifProposalLoaded" checked>
                Proposal loaded
              </label>
              <label class="toggle-label sub">
                <input type="checkbox" id="notif-errors" name="notifErrors" checked>
                Errors
              </label>
            </div>
          </section>
        </main>

        <footer>
          <div id="save-status" class="save-status" aria-live="polite"></div>
          <button id="save-btn" type="button">Save Settings</button>
        </footer>
      </div>

      <script src="popup.js"></script>
    </body>
    </html>
    ```

    --- src/popup/popup.css ---
    ```css
    /* Reset & base */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      color: #1f2937;
      background: #ffffff;
      width: 320px;
      min-height: 100px;
    }

    #app {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    /* Header */
    header {
      background: #1d4354;
      padding: 10px 14px;
    }

    header h1 {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 0.01em;
    }

    /* Main content */
    main {
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Setting groups */
    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .setting-group label,
    .setting-group .label {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Inputs */
    input[type="url"],
    select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      color: #1f2937;
      background: #f9fafb;
      outline: none;
      transition: border-color 0.15s;
    }

    input[type="url"]:focus,
    select:focus {
      border-color: #14a800;
      background: #ffffff;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Radio group */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #1f2937;
      cursor: pointer;
    }

    input[type="radio"] {
      accent-color: #14a800;
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    /* Notification toggles */
    .toggle-row {
      display: flex;
      align-items: center;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #1f2937;
      cursor: pointer;
      font-weight: normal;
      text-transform: none;
      letter-spacing: normal;
    }

    .toggle-label.sub {
      font-size: 12px;
      color: #374151;
    }

    .notif-subtypes {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-left: 20px;
      border-left: 2px solid #e5e7eb;
      margin-top: 2px;
    }

    .notif-subtypes.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    input[type="checkbox"] {
      accent-color: #14a800;
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    /* Footer */
    footer {
      padding: 10px 14px 12px;
      border-top: 1px solid #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .save-status {
      font-size: 11px;
      color: #14a800;
      min-height: 14px;
      flex: 1;
    }

    .save-status.error {
      color: #dc2626;
    }

    #save-btn {
      padding: 6px 14px;
      background: #14a800;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }

    #save-btn:hover {
      background: #108c00;
    }

    #save-btn:active {
      background: #0d7300;
    }
    ```
  </action>
  <verify>Open popup by clicking extension icon. Form shows all four sections: webhook URL input, interval dropdown, output radio buttons, notification checkboxes. No horizontal scrollbar. No layout overflow.</verify>
  <done>All four setting sections visible in popup. UI is clean with no errors in DevTools console.</done>
</task>

<task type="auto">
  <name>Task 2: Wire popup.js — load from storage on open, save on button click</name>
  <files>
    src/popup/popup.js
  </files>
  <action>
    Replace the placeholder popup.js with full settings logic. Follow the NotificationManager safe-fail pattern from the global class registry: all chrome.storage calls are wrapped in try/catch and errors surface in the UI rather than crashing the popup.

    Storage key schema (canonical — all future phases read these exact keys):
    - webhookUrl: string
    - scheduleInterval: number (minutes)
    - outputFormat: "webhook" | "csv" | "both"
    - notifications.master: boolean
    - notifications.scrapeComplete: boolean
    - notifications.webhookSent: boolean
    - notifications.proposalLoaded: boolean
    - notifications.errors: boolean

    ```javascript
    // Upwork Job Scraper — Popup Settings
    // Pattern: NotificationManager safe-fail (global class registry) adapted for chrome.storage
    // All storage operations wrapped in try/catch — errors shown in UI, never crash popup

    // ─── Default values ──────────────────────────────────────────────────────────
    const DEFAULTS = {
      webhookUrl: '',
      scheduleInterval: 30,
      outputFormat: 'both',
      notifications: {
        master: true,
        scrapeComplete: true,
        webhookSent: true,
        proposalLoaded: true,
        errors: true,
      },
    };

    // ─── DOM refs ─────────────────────────────────────────────────────────────────
    const els = {
      webhookUrl:         () => document.getElementById('webhook-url'),
      scheduleInterval:   () => document.getElementById('schedule-interval'),
      outputFormat:       () => document.querySelector('input[name="outputFormat"]:checked'),
      outputFormatAll:    () => document.querySelectorAll('input[name="outputFormat"]'),
      notifMaster:        () => document.getElementById('notif-master'),
      notifSubtypes:      () => document.getElementById('notif-subtypes'),
      notifScrapeComplete:() => document.getElementById('notif-scrape-complete'),
      notifWebhookSent:   () => document.getElementById('notif-webhook-sent'),
      notifProposalLoaded:() => document.getElementById('notif-proposal-loaded'),
      notifErrors:        () => document.getElementById('notif-errors'),
      saveBtn:            () => document.getElementById('save-btn'),
      saveStatus:         () => document.getElementById('save-status'),
    };

    // ─── Status display ───────────────────────────────────────────────────────────
    function showStatus(message, isError = false) {
      const el = els.saveStatus();
      el.textContent = message;
      el.className = 'save-status' + (isError ? ' error' : '');
      // Auto-clear after 2.5s
      setTimeout(() => {
        if (el.textContent === message) {
          el.textContent = '';
          el.className = 'save-status';
        }
      }, 2500);
    }

    // ─── Master toggle — dims subtypes when disabled ───────────────────────────
    function applyMasterToggleState(masterChecked) {
      const subtypes = els.notifSubtypes();
      if (masterChecked) {
        subtypes.classList.remove('disabled');
      } else {
        subtypes.classList.add('disabled');
      }
    }

    // ─── Load settings from storage ──────────────────────────────────────────────
    async function loadSettings() {
      try {
        const stored = await chrome.storage.local.get(null); // get all keys

        // Merge stored values over defaults (deep merge for notifications object)
        const settings = {
          webhookUrl:       stored.webhookUrl       ?? DEFAULTS.webhookUrl,
          scheduleInterval: stored.scheduleInterval ?? DEFAULTS.scheduleInterval,
          outputFormat:     stored.outputFormat     ?? DEFAULTS.outputFormat,
          notifications: {
            master:          stored['notifications.master']          ?? DEFAULTS.notifications.master,
            scrapeComplete:  stored['notifications.scrapeComplete']   ?? DEFAULTS.notifications.scrapeComplete,
            webhookSent:     stored['notifications.webhookSent']      ?? DEFAULTS.notifications.webhookSent,
            proposalLoaded:  stored['notifications.proposalLoaded']   ?? DEFAULTS.notifications.proposalLoaded,
            errors:          stored['notifications.errors']           ?? DEFAULTS.notifications.errors,
          },
        };

        // Apply to DOM
        els.webhookUrl().value = settings.webhookUrl;

        els.scheduleInterval().value = String(settings.scheduleInterval);

        els.outputFormatAll().forEach(radio => {
          radio.checked = (radio.value === settings.outputFormat);
        });

        els.notifMaster().checked        = settings.notifications.master;
        els.notifScrapeComplete().checked = settings.notifications.scrapeComplete;
        els.notifWebhookSent().checked    = settings.notifications.webhookSent;
        els.notifProposalLoaded().checked = settings.notifications.proposalLoaded;
        els.notifErrors().checked         = settings.notifications.errors;

        applyMasterToggleState(settings.notifications.master);

      } catch (err) {
        // Safe-fail: log and surface in UI, never crash popup (NotificationManager pattern)
        console.error('[Popup] Failed to load settings:', err);
        showStatus('Failed to load settings', true);
      }
    }

    // ─── Save settings to storage ─────────────────────────────────────────────────
    async function saveSettings() {
      try {
        const selectedFormat = els.outputFormat();

        const settings = {
          webhookUrl:                      els.webhookUrl().value.trim(),
          scheduleInterval:                parseInt(els.scheduleInterval().value, 10),
          outputFormat:                    selectedFormat ? selectedFormat.value : DEFAULTS.outputFormat,
          'notifications.master':          els.notifMaster().checked,
          'notifications.scrapeComplete':  els.notifScrapeComplete().checked,
          'notifications.webhookSent':     els.notifWebhookSent().checked,
          'notifications.proposalLoaded':  els.notifProposalLoaded().checked,
          'notifications.errors':          els.notifErrors().checked,
        };

        await chrome.storage.local.set(settings);

        console.log('[Popup] Settings saved:', settings);
        showStatus('Saved');

      } catch (err) {
        // Safe-fail: surface error in UI, do not throw (NotificationManager pattern)
        console.error('[Popup] Failed to save settings:', err);
        showStatus('Failed to save', true);
      }
    }

    // ─── Event bindings ───────────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', () => {
      // Load on open
      loadSettings();

      // Master notification toggle dims subtypes immediately on change
      els.notifMaster().addEventListener('change', (e) => {
        applyMasterToggleState(e.target.checked);
      });

      // Save button
      els.saveBtn().addEventListener('click', saveSettings);
    });
    ```

    Storage key format note: notification sub-keys use dot notation as flat keys in chrome.storage.local
    (e.g., `'notifications.master'`). This avoids nested object merge complexity in future phases — each
    setting is addressable independently with chrome.storage.local.get(['notifications.master']).
  </action>
  <verify>
    1. Open popup — all fields are pre-filled with defaults (interval shows "Every 30 minutes", "Both" radio is selected, all notification checkboxes checked).
    2. Enter a webhook URL, change interval to 60 min, select "CSV only", uncheck "Scrape complete".
    3. Click "Save Settings" — status shows "Saved" briefly.
    4. Close and reopen popup — all changed values are still set.
    5. Uncheck "Enable notifications" master toggle — sub-checkboxes become visually dimmed/disabled.
    6. DevTools → Application → Storage → Local Storage → chrome-extension:// — verify all keys are present.
  </verify>
  <done>
    Settings persist across popup close/reopen. Defaults applied on first open. Master notification toggle controls sub-type availability. All eight storage keys written on save (webhookUrl, scheduleInterval, outputFormat, notifications.master, notifications.scrapeComplete, notifications.webhookSent, notifications.proposalLoaded, notifications.errors).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full settings popup: webhook URL input (SETT-01), schedule interval dropdown (SETT-02), output format radio group (SETT-03), notification toggles with master + 4 sub-types (SETT-04). All settings persist to chrome.storage.local and reload on popup open.
  </what-built>
  <how-to-verify>
    1. Open chrome://extensions — extension card shows no error badge.
    2. Click extension icon — popup opens, ~320px wide, all four sections visible.
    3. Enter any text in the Webhook URL field and save — reopen, URL is still there.
    4. Change interval to "Every 60 minutes", save — reopen, interval is still 60.
    5. Select "Webhook only" output, save — reopen, "Webhook only" is still selected.
    6. Uncheck "Errors" notification, save — reopen, "Errors" is still unchecked.
    7. Uncheck "Enable notifications" master — the four sub-checkboxes visually dim.
    8. DevTools console (popup window) — no errors during open or save.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe what is wrong.</resume-signal>
</task>

</tasks>

<verification>
chrome.storage.local should contain after a save:
  - webhookUrl: string
  - scheduleInterval: 15 | 30 | 60 | 120
  - outputFormat: "webhook" | "csv" | "both"
  - notifications.master: true | false
  - notifications.scrapeComplete: true | false
  - notifications.webhookSent: true | false
  - notifications.proposalLoaded: true | false
  - notifications.errors: true | false

Verify via DevTools: Application tab > Storage > Local Storage > chrome-extension://[id]
All 8 keys should be present after first save.
</verification>

<success_criteria>
- SETT-01: Webhook URL saved and reloaded correctly
- SETT-02: Schedule interval dropdown persists selection
- SETT-03: Output format radio persists selection
- SETT-04: All 5 notification toggles persist (1 master + 4 types)
- Defaults applied on first open (no prior storage)
- Storage errors surfaced in UI, never crash popup (safe-fail pattern)
- File count: 3 files created/modified (popup.html, popup.js, popup.css)
</success_criteria>

<output>
After checkpoint approval, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following the summary template.
Key facts to capture: storage key schema (all 8 keys with exact names), default values, safe-fail pattern applied, notification master toggle behavior, popup dimensions (320px).
</output>
