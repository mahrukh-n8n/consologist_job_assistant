---
phase: 03-webhook-integration-search-overlay
plan: 03
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - src/utils/csv-exporter.js
  - src/background/service-worker.js
  - src/popup/popup.html
  - src/popup/popup.js
autonomous: false
requirements:
  - EXPT-01
  - EXPT-02

must_haves:
  truths:
    - "User can click 'Export CSV' in the popup and the browser saves a .csv file to the downloads folder"
    - "The CSV file has exactly 15 column headers matching the reference project field names (case-sensitive): job_id, title, url, description, budget, payment_type, skills, experience_level, project_duration, posted_date, proposals_count, client_payment_verified, client_location, client_rating, client_total_spent"
    - "If outputFormat is 'webhook' (not 'csv' or 'both'), clicking Export CSV shows a message that CSV export is disabled for the current mode and no file is downloaded"
    - "If no scraped jobs are stored (lastScrapedJobs is empty or missing), clicking Export CSV shows 'No data to export' feedback and no file is downloaded"
    - "If outputFormat is 'csv' or 'both', clicking Export CSV downloads a file named 'upwork-jobs.csv' without a Save As dialog"
  artifacts:
    - path: "src/utils/csv-exporter.js"
      provides: "CsvExporter class with generateCsv(jobs) method"
      exports: ["CsvExporter"]
    - path: "src/background/service-worker.js"
      provides: "EXPORT_CSV message handler — reads lastScrapedJobs and outputFormat from storage, generates CSV via CsvExporter, triggers chrome.downloads.download"
      contains: "EXPORT_CSV"
    - path: "src/popup/popup.html"
      provides: "Export CSV button element"
      contains: "export-csv-btn"
    - path: "src/popup/popup.js"
      provides: "Export CSV button click handler — sends EXPORT_CSV message, shows feedback"
      contains: "EXPORT_CSV"
  key_links:
    - from: "src/popup/popup.js"
      to: "src/background/service-worker.js"
      via: "chrome.runtime.sendMessage"
      pattern: "EXPORT_CSV"
    - from: "src/background/service-worker.js"
      to: "src/utils/csv-exporter.js"
      via: "import { CsvExporter }"
      pattern: "CsvExporter"
    - from: "src/background/service-worker.js"
      to: "chrome.downloads.download"
      via: "data: URI with encodeURIComponent"
      pattern: "data:text/csv"
---

<objective>
Build the CSV export capability: a CsvExporter utility, a service worker message handler that generates and downloads the CSV, and an Export CSV button in the popup that triggers the flow.

Purpose: Close EXPT-01 (save scraped data as CSV to downloads) and EXPT-02 (output mode guard — only export when mode includes csv).
Output: src/utils/csv-exporter.js (new), updated src/background/service-worker.js (EXPORT_CSV handler), updated src/popup/popup.html and popup.js (Export CSV button + feedback).
</objective>

<execution_context>
@C:/Users/Glorvax/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/PROJECT.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/ROADMAP.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/STATE.md

## Storage key for output format

The popup stores the user's output mode under the key `outputFormat` (not `outputMode`) in chrome.storage.local.
Values: "webhook" | "csv" | "both"
CSV export fires when: outputFormat === "csv" || outputFormat === "both"

## Storage key for scraped data

The service worker stores the most recent scrape under the key `lastScrapedJobs` in chrome.storage.local.
Value: array of job objects, each with the 15 reference fields.

## Reference field names (CRITICAL — case-sensitive, must be CSV column headers in this exact order)

job_id, title, url, description, budget, payment_type, skills, experience_level, project_duration, posted_date, proposals_count, client_payment_verified, client_location, client_rating, client_total_spent

## MV3 download pattern (service worker safe)

The service worker cannot create Blob/URL.createObjectURL. Use the data: URI approach:
```js
const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString);
chrome.downloads.download({ url: dataUri, filename: 'upwork-jobs.csv', saveAs: false });
```

## CSV escaping rules

RFC 4180 minimal escaping:
- Wrap any value containing a comma, double-quote, or newline in double-quotes
- Escape double-quotes inside a value by doubling them: " becomes ""
- null/undefined values become empty string
- Arrays (e.g. skills field) join with semicolons before escaping

## Existing popup patterns

popup.js uses:
- `showStatus(message, isError)` for transient UI feedback (auto-clears after 2.5s)
- `els` object with DOM ref functions (lazy getters)
- `DOMContentLoaded` for all event bindings

Export CSV button must follow the same pattern: lazy DOM ref in `els`, bound in DOMContentLoaded, shows feedback via showStatus.

## Existing service worker message handling pattern

The service worker already handles: SCRAPE_SEARCH, SCRAPE_DETAIL, PUSH_JOBS, GET_MATCH_STATUS.
All async handlers return true to keep port open. Add EXPORT_CSV as another case in the existing listener — do NOT create a second chrome.runtime.onMessage listener.
</context>

<tasks>

<task type="auto">
  <name>Task 1: CsvExporter utility and EXPORT_CSV service worker handler</name>
  <files>src/utils/csv-exporter.js, src/background/service-worker.js</files>
  <action>
**src/utils/csv-exporter.js — create new file:**

Export a class CsvExporter with one method: generateCsv(jobs).

```
FIELD_ORDER = [
  'job_id', 'title', 'url', 'description', 'budget', 'payment_type',
  'skills', 'experience_level', 'project_duration', 'posted_date',
  'proposals_count', 'client_payment_verified', 'client_location',
  'client_rating', 'client_total_spent'
]
```

generateCsv(jobs) implementation:
1. Start with header row: FIELD_ORDER joined by commas
2. For each job object in jobs array, produce a row:
   a. For each field in FIELD_ORDER, get the value: job[field] ?? ''
   b. If value is an array (e.g. skills): join with ';' → String
   c. Convert to string: String(value)
   d. Escape: if the string contains a comma, double-quote, or newline → wrap in double-quotes and replace each " with ""
   e. Collect escaped values into row string joined by commas
3. Join header + all rows with '\r\n' (CRLF, per RFC 4180)
4. Return the complete CSV string

If jobs is empty or not an array: return just the header row (no data rows).

Export as ES module: export class CsvExporter { ... }

No constructor needed. No external dependencies.

---

**src/background/service-worker.js — add EXPORT_CSV handler:**

At the top of the file, add import alongside existing imports:
```js
import { CsvExporter } from '../utils/csv-exporter.js';
```

In the existing chrome.runtime.onMessage listener, add a case for action === 'EXPORT_CSV':

Handler logic:
1. Read from chrome.storage.local: { outputFormat, lastScrapedJobs }
2. Guard — outputFormat is 'webhook' (not 'csv' or 'both'):
   - Return { success: false, reason: 'csv_disabled', message: 'CSV export is disabled for webhook-only mode' }
3. Guard — lastScrapedJobs is missing, not an array, or empty:
   - Return { success: false, reason: 'no_data', message: 'No scraped jobs to export' }
4. Generate CSV string:
   - const exporter = new CsvExporter()
   - const csvString = exporter.generateCsv(lastScrapedJobs)
5. Build data URI:
   - const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString)
6. Trigger download:
   - chrome.downloads.download({ url: dataUri, filename: 'upwork-jobs.csv', saveAs: false })
7. Return { success: true, count: lastScrapedJobs.length }

The handler must be async. Use the sendResponse callback pattern to keep the port open:
```js
if (message.action === 'EXPORT_CSV') {
  handleExportCsv(message).then(sendResponse);
  return true;
}
```

Define handleExportCsv as a standalone async function above the listener.

Do NOT create a second chrome.runtime.onMessage listener.
  </action>
  <verify>
1. Inspect src/utils/csv-exporter.js:
   - FIELD_ORDER constant has all 15 fields in exact reference order
   - generateCsv(jobs) method present
   - Array values joined with ';' before escaping
   - CSV escaping wraps values containing comma/quote/newline in double-quotes, doubles internal quotes
   - Returns header-only string for empty array
   - export class CsvExporter present
2. Inspect src/background/service-worker.js:
   - CsvExporter imported at top
   - EXPORT_CSV case/handler present in message listener
   - outputFormat guard: returns csv_disabled reason when 'webhook'
   - lastScrapedJobs guard: returns no_data reason when missing/empty
   - chrome.downloads.download called with data: URI and filename 'upwork-jobs.csv'
   - returns true to keep port open
3. Load extension in Chrome (chrome://extensions -> Load unpacked)
4. Open service worker DevTools (Inspect views -> service worker): confirm no syntax errors on load
  </verify>
  <done>CsvExporter class generates RFC 4180 CSV with all 15 reference headers. Service worker EXPORT_CSV handler reads outputFormat and lastScrapedJobs from storage, guards on both, downloads via data: URI when conditions pass.</done>
</task>

<task type="auto">
  <name>Task 2: Export CSV button in popup</name>
  <files>src/popup/popup.html, src/popup/popup.js</files>
  <action>
**src/popup/popup.html — add Export CSV button:**

In the footer section, add the Export CSV button BEFORE the existing Save Settings button. The footer currently has:
```html
<footer>
  <div id="save-status" class="save-status" aria-live="polite"></div>
  <button id="save-btn" type="button">Save Settings</button>
</footer>
```

Update to:
```html
<footer>
  <div id="save-status" class="save-status" aria-live="polite"></div>
  <button id="export-csv-btn" type="button">Export CSV</button>
  <button id="save-btn" type="button">Save Settings</button>
</footer>
```

No other HTML changes.

---

**src/popup/popup.js — wire Export CSV button:**

1. Add to the `els` object:
   ```js
   exportCsvBtn: () => document.getElementById('export-csv-btn'),
   ```

2. Add sendExportCsv function after the saveSettings function:
   ```js
   async function sendExportCsv() {
     const btn = els.exportCsvBtn();
     btn.disabled = true;
     btn.textContent = 'Exporting...';
     try {
       const response = await new Promise((resolve) => {
         chrome.runtime.sendMessage({ action: 'EXPORT_CSV' }, (res) => {
           if (chrome.runtime.lastError) {
             resolve({ success: false, message: chrome.runtime.lastError.message });
           } else {
             resolve(res);
           }
         });
       });

       if (response?.success) {
         showStatus('Exported ' + (response.count ?? '') + ' jobs');
       } else if (response?.reason === 'csv_disabled') {
         showStatus('CSV export is off — change Output Format to CSV or Both', true);
       } else if (response?.reason === 'no_data') {
         showStatus('No data to export — run a scrape first', true);
       } else {
         showStatus(response?.message ?? 'Export failed', true);
       }
     } catch (err) {
       console.error('[Popup] Export CSV error:', err);
       showStatus('Export failed', true);
     } finally {
       btn.disabled = false;
       btn.textContent = 'Export CSV';
     }
   }
   ```

3. In the DOMContentLoaded listener, bind the button:
   ```js
   els.exportCsvBtn().addEventListener('click', sendExportCsv);
   ```

   Add this line immediately after the existing `els.saveBtn().addEventListener('click', saveSettings);` binding.

Do not modify loadSettings, saveSettings, showStatus, applyMasterToggleState, or any existing bindings.
  </action>
  <verify>
1. Inspect src/popup/popup.html: export-csv-btn button present in footer, before save-btn
2. Inspect src/popup/popup.js:
   - exportCsvBtn in els object
   - sendExportCsv function present with Promise-wrapped sendMessage
   - chrome.runtime.lastError handled
   - Button shows 'Exporting...' during request, resets to 'Export CSV' after
   - DOMContentLoaded binds exportCsvBtn click to sendExportCsv
3. Open extension popup in Chrome: confirm 'Export CSV' button visible above 'Save Settings'
4. With outputFormat set to 'webhook': click Export CSV → status shows CSV disabled message
5. With outputFormat set to 'csv' or 'both' but no lastScrapedJobs: click Export CSV → status shows 'No data to export'
  </verify>
  <done>Popup has an 'Export CSV' button that sends EXPORT_CSV to the service worker, shows transient feedback for success/csv_disabled/no_data/error states, and disables itself during the request to prevent double-clicks.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    CSV export end-to-end: CsvExporter utility with 15-column reference headers, service worker EXPORT_CSV handler with outputFormat and data guards, and Export CSV button in the popup with feedback states.
  </what-built>
  <how-to-verify>
    1. Load the extension in Chrome (chrome://extensions -> Load unpacked -> select project root). Confirm no errors on the extensions page.
    2. Open the service worker DevTools (Inspect views -> service worker). Confirm no syntax errors logged on startup.
    3. Open the extension popup. Confirm the 'Export CSV' button appears above 'Save Settings'.
    4. Test guard — webhook-only mode:
       a. Set Output Format to 'Webhook only' and save.
       b. Click 'Export CSV'.
       c. Expected: status message says CSV is disabled (no file download, no browser save dialog).
    5. Test guard — no data:
       a. Set Output Format to 'CSV only' or 'Both' and save.
       b. Click 'Export CSV' before running any scrape (or clear lastScrapedJobs from DevTools -> Application -> Local Storage).
       c. Expected: status message says 'No data to export' (no file download).
    6. Test successful export:
       a. In the service worker DevTools console, manually inject test data:
          chrome.storage.local.set({ lastScrapedJobs: [{ job_id: 'test-01', title: 'Test Job', url: 'https://upwork.com/jobs/~test01', description: 'A test', budget: '$500', payment_type: 'fixed', skills: ['JavaScript', 'Node.js'], experience_level: 'intermediate', project_duration: '1-3 months', posted_date: '2026-02-18', proposals_count: 5, client_payment_verified: true, client_location: 'US', client_rating: 4.9, client_total_spent: '$10k+' }] })
       b. Ensure outputFormat is 'csv' or 'both'.
       c. Click 'Export CSV' in the popup.
       d. Expected: browser downloads 'upwork-jobs.csv' without a Save As dialog. Popup shows 'Exported 1 jobs'.
    7. Open the downloaded upwork-jobs.csv in a text editor. Verify:
       - First row (header): job_id,title,url,description,budget,payment_type,skills,experience_level,project_duration,posted_date,proposals_count,client_payment_verified,client_location,client_rating,client_total_spent
       - Second row: test-01,Test Job,https://upwork.com/jobs/~test01,A test,$500,fixed,JavaScript;Node.js,intermediate,1-3 months,2026-02-18,5,true,US,4.9,$10k+
       - Exactly 15 columns in each row, column names matching reference exactly (case-sensitive).
  </how-to-verify>
  <resume-signal>Type "approved" if all three guards work correctly and the downloaded CSV has the correct headers and data row, or describe any issues (wrong headers, missing button, guard not firing, download not triggering).</resume-signal>
</task>

</tasks>

<verification>
End-to-end checks:
- Extension loads without errors (chrome://extensions and service worker console)
- Export CSV button appears in popup, above Save Settings
- outputFormat guard works: no download when mode is 'webhook'
- lastScrapedJobs guard works: no download when storage key is absent/empty
- Successful export: downloads 'upwork-jobs.csv' without Save As dialog
- CSV headers in downloaded file match all 15 reference field names exactly (case-sensitive, in reference order)
- skills array values appear as semicolon-separated strings in the CSV
- Popup feedback is accurate for all outcomes (success, csv_disabled, no_data, error)
</verification>

<success_criteria>
- CsvExporter.generateCsv() produces valid CSV with all 15 reference headers in reference order (EXPT-01)
- EXPORT_CSV handler skips download when outputFormat is 'webhook' and proceeds when 'csv' or 'both' (EXPT-02)
- chrome.downloads.download called with data: URI — no Blob/URL.createObjectURL in service worker
- 'Export CSV' button appears in popup and provides accurate feedback for every response state
- No second chrome.runtime.onMessage listener created in service worker
- No syntax errors in any modified file when extension loads
</success_criteria>

<output>
After completion, create `.planning/phases/03-webhook-integration-search-overlay/03-03-SUMMARY.md` using the summary template. Include: CsvExporter field order documented, EXPORT_CSV message contract (input/output shapes), storage keys used (outputFormat, lastScrapedJobs), data: URI download pattern documented, any deviations from plan.
</output>
