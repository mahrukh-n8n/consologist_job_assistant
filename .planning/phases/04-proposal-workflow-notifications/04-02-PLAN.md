---
phase: 04-proposal-workflow-notifications
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/background/service-worker.js
  - src/popup/popup.html
  - src/popup/popup.js
  - src/popup/popup.css
autonomous: false
requirements: [NOTF-01, NOTF-02]

must_haves:
  truths:
    - "After a scrape completes, a Windows toast notification appears with the job count summary (e.g., 'Scraped 5 jobs') — but only if notifications.master and notifications.scrapeComplete are both enabled in storage"
    - "After a webhook push completes, a Windows toast notification appears (e.g., 'Webhook: sent 5 jobs') — only if notifications.master and notifications.webhookSent are both enabled"
    - "After a proposal loads successfully, a Windows toast notification appears (e.g., 'Proposal loaded') — only if notifications.master and notifications.proposalLoaded are both enabled"
    - "When any handler encounters an error, a Windows toast notification appears with an error summary — only if notifications.master and notifications.errors are both enabled"
    - "The popup shows an inline status message (e.g., 'Settings saved', 'Webhook: sent 5 jobs', 'Proposal: loaded') without navigating away or blocking the UI"
    - "Popup status messages auto-clear after 5 seconds"
    - "Disabling the master notification toggle suppresses all toast notifications but does not affect popup status messages"
  artifacts:
    - path: "src/background/service-worker.js"
      provides: "fireNotification(type, message) helper + notification call-sites in all relevant handlers"
      contains: "fireNotification"
    - path: "src/popup/popup.html"
      provides: "Status display area (#ext-status) below save button"
      contains: "ext-status"
    - path: "src/popup/popup.js"
      provides: "showExtStatus(message, type) function and call-sites wired to service worker responses"
      contains: "showExtStatus"
    - path: "src/popup/popup.css"
      provides: "Styles for #ext-status (success green, error red, hidden by default)"
      contains: "ext-status"
  key_links:
    - from: "src/background/service-worker.js (SCRAPE_SEARCH handler)"
      to: "chrome.notifications API"
      via: "fireNotification('scrapeComplete', 'Scraped N jobs')"
      pattern: "fireNotification"
    - from: "src/background/service-worker.js (PUSH_JOBS handler)"
      to: "chrome.notifications API"
      via: "fireNotification('webhookSent', 'Webhook: sent N jobs')"
      pattern: "fireNotification"
    - from: "src/background/service-worker.js (LOAD_PROPOSAL handler)"
      to: "chrome.notifications API"
      via: "fireNotification('proposalLoaded', 'Proposal loaded')"
      pattern: "fireNotification"
    - from: "src/popup/popup.js (message response callbacks)"
      to: "src/popup/popup.html #ext-status div"
      via: "showExtStatus(message, 'success'|'error')"
      pattern: "showExtStatus"
---

<objective>
Implement chrome.notifications toast alerts for scrape, webhook, proposal, and error events (NOTF-01), and add an inline status display area to the popup for real-time feedback (NOTF-02).

Purpose: The user needs to know what the extension is doing even when the popup is closed (toast notifications) and when it is open (inline status). Both features read from the notification preference keys already stored by Phase 1's settings UI — no new storage keys are introduced.

Output: A `fireNotification(type, message)` helper in the service worker wired to all relevant message handlers; a `#ext-status` div in the popup with `showExtStatus()` logic.
</objective>

<execution_context>
@C:/Users/Glorvax/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/PROJECT.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/ROADMAP.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/STATE.md
@C:/Users/Glorvax/Documents/upwork chrome extention/src/background/service-worker.js
@C:/Users/Glorvax/Documents/upwork chrome extention/src/popup/popup.html
@C:/Users/Glorvax/Documents/upwork chrome extention/src/popup/popup.js
@C:/Users/Glorvax/Documents/upwork chrome extention/src/popup/popup.css
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/phases/04-proposal-workflow-notifications/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: fireNotification helper and toast call-sites in service worker</name>
  <files>src/background/service-worker.js</files>
  <action>
Add a `fireNotification(type, message)` async helper to `src/background/service-worker.js`. Place it near the top of the file, after the lifecycle listeners and before the message router.

```js
// ─── Notification helper (NOTF-01) ────────────────────────────────────────────
// Reads from flat dot-notation keys set by Phase 1 popup settings.
// type: 'scrapeComplete' | 'webhookSent' | 'proposalLoaded' | 'errors'
async function fireNotification(type, message) {
  try {
    const keys = ['notifications.master', `notifications.${type}`];
    const settings = await chrome.storage.local.get(keys);
    if (!settings['notifications.master']) return;
    if (!settings[`notifications.${type}`]) return;
    chrome.notifications.create('ext-notif-' + Date.now(), {
      type: 'basic',
      iconUrl: 'icons/icon48.svg',
      title: 'Consologit_Job_Assistant',
      message
    });
  } catch (err) {
    // Safe-fail: notification failures must never crash the service worker
    console.error('[SW] fireNotification failed:', err);
  }
}
```

Then add notification call-sites inside the existing `chrome.runtime.onMessage.addListener` handler. The handlers for SCRAPE_SEARCH, SCRAPE_DETAIL, PUSH_JOBS, LOAD_PROPOSAL, and EXPORT_CSV will be added by Phases 2-4 plans. For this plan, add the notification calls at each handler's success and error exit points. Use the pattern below for each:

**SCRAPE_SEARCH success** — call after jobs array is returned:
```js
await fireNotification('scrapeComplete', `Scraped ${jobs.length} jobs from search`);
```

**SCRAPE_DETAIL success** — call after single job data is returned:
```js
await fireNotification('scrapeComplete', 'Job detail scraped');
```

**PUSH_JOBS success** — call after webhook POST returns ok:
```js
await fireNotification('webhookSent', `Webhook: sent ${jobs.length} jobs`);
```

**LOAD_PROPOSAL success** — call inside `handleLoadProposal` after `sendResponse({ proposal: proposalText.trim() })`:
```js
await fireNotification('proposalLoaded', 'Proposal loaded');
```

**EXPORT_CSV success** — call after chrome.downloads.download completes:
```js
await fireNotification('scrapeComplete', 'CSV exported to downloads folder');
```

**Any handler's catch block** — call before or after `sendResponse({ error: ... })`:
```js
await fireNotification('errors', `Error: ${err.message}`);
```

Important implementation notes:
- The handlers for SCRAPE_SEARCH, SCRAPE_DETAIL, PUSH_JOBS, EXPORT_CSV are stubs at this point (Phases 2-3 implement them). Add the `fireNotification` calls as commented placeholders in the message router where those handlers will live, and add the actual calls inside `handleLoadProposal` (which already exists from plan 04-01) immediately.
- For `handleLoadProposal` specifically: add `await fireNotification('proposalLoaded', 'Proposal loaded');` immediately before or after `sendResponse({ proposal: proposalText.trim() })`. Add `await fireNotification('errors', 'Proposal load failed: ' + err.message);` inside the catch block before `sendResponse({ error: ... })`.
- Do NOT restructure or remove existing handler stubs from earlier phases. Only add fireNotification calls.
- The `notifications` permission is already declared in manifest.json — no manifest changes needed.
  </action>
  <verify>
1. Reload the extension in chrome://extensions (click the refresh icon).
2. Open chrome://extensions, click "Service Worker" to open the SW DevTools console — confirm no errors on load.
3. In the SW console run:
   ```js
   fireNotification('scrapeComplete', 'Test: scrape complete');
   ```
   Expected: a Windows toast notification appears in the bottom-right corner titled "Consologit_Job_Assistant" with message "Test: scrape complete" (assuming notifications.master defaults to true in storage).
4. In SW console, set master off then retry:
   ```js
   chrome.storage.local.set({'notifications.master': false}).then(() => fireNotification('scrapeComplete', 'Should not appear'));
   ```
   Expected: no notification fires.
5. Restore master: `chrome.storage.local.set({'notifications.master': true})`.
  </verify>
  <done>
- `fireNotification` function exists in src/background/service-worker.js.
- Function reads both `notifications.master` and `notifications.{type}` before firing.
- Toast notifications appear when both toggles are true; suppressed when master is false.
- `fireNotification('proposalLoaded', ...)` and `fireNotification('errors', ...)` are wired into the `handleLoadProposal` function.
- Commented placeholder call-sites exist for SCRAPE_SEARCH, SCRAPE_DETAIL, PUSH_JOBS, EXPORT_CSV handlers.
- No uncaught exceptions — fireNotification is fully try/catch wrapped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Popup inline status display for NOTF-02</name>
  <files>src/popup/popup.html, src/popup/popup.js, src/popup/popup.css</files>
  <action>
The popup already has `#save-status` (in the footer, for save feedback) and `showStatus()`. This task adds a second, distinct status area (`#ext-status`) for service worker action feedback — webhook results, proposal load results, and errors from extension operations. These are separate concerns and should be separate elements.

**A. popup.html — add #ext-status div**

In `src/popup/popup.html`, add a new `<div id="ext-status">` immediately before the closing `</div>` that ends `#app` (i.e., as the last child of `#app`, after `</footer>`):

```html
    <!-- NOTF-02: Extension action status (webhook, proposal, errors) -->
    <div id="ext-status" class="ext-status" aria-live="polite" role="status"></div>
```

**B. popup.css — add #ext-status styles**

In `src/popup/popup.css`, append at the end of the file:

```css
/* NOTF-02: Extension action status display */
.ext-status {
  font-size: 11px;
  min-height: 0;
  max-height: 0;
  overflow: hidden;
  padding: 0 14px;
  transition: max-height 0.2s ease, padding 0.2s ease;
  color: #14a800;
}

.ext-status.visible {
  min-height: 24px;
  max-height: 60px;
  padding: 6px 14px;
  border-top: 1px solid #f3f4f6;
}

.ext-status.error {
  color: #dc2626;
}
```

**C. popup.js — add showExtStatus() and wire to response handlers**

In `src/popup/popup.js`, add a new function `showExtStatus(message, type)` after the existing `showStatus()` function:

```js
// ─── Extension action status (NOTF-02) ────────────────────────────────────────
// Shows service worker response feedback (webhook, proposal, errors).
// Distinct from showStatus() which is for save-button feedback only.
let extStatusTimer = null;

function showExtStatus(message, type = 'success') {
  const el = document.getElementById('ext-status');
  if (!el) return;
  el.textContent = message;
  el.className = 'ext-status visible' + (type === 'error' ? ' error' : '');
  // Cancel any pending auto-clear
  if (extStatusTimer) clearTimeout(extStatusTimer);
  // Auto-clear after 5 seconds
  extStatusTimer = setTimeout(() => {
    el.textContent = '';
    el.className = 'ext-status';
    extStatusTimer = null;
  }, 5000);
}
```

Add `extStatus` to the existing `els` DOM ref object (after the `saveStatus` entry):

```js
extStatus: () => document.getElementById('ext-status'),
```

Add a pattern comment block at the bottom of `popup.js` (after all event bindings) showing how future phases should wire action buttons to showExtStatus:

```js
// ─── Pattern for future action buttons (Phases 2-3 popup additions) ──────────
// When adding scrape/webhook action buttons, wire responses like this:
//
//   chrome.runtime.sendMessage({ action: 'SCRAPE_SEARCH' }, (response) => {
//     if (response && response.error) {
//       showExtStatus('Error: ' + response.error, 'error');
//     } else if (response) {
//       showExtStatus('Scraped ' + (response.jobs?.length ?? 0) + ' jobs', 'success');
//     }
//   });
//
//   chrome.runtime.sendMessage({ action: 'LOAD_PROPOSAL', jobData }, (response) => {
//     if (response && response.error) {
//       showExtStatus('Proposal error: ' + response.error, 'error');
//     } else if (response) {
//       showExtStatus('Proposal: loaded', 'success');
//     }
//   });
```

Do NOT modify `showStatus()` or any existing event bindings — the save button's `#save-status` feedback is untouched.
  </action>
  <verify>
1. Reload the extension in chrome://extensions.
2. Open the popup. Confirm it renders without visual changes (ext-status div is invisible by default, height 0).
3. In the popup's DevTools console (right-click popup -> Inspect), run:
   ```js
   showExtStatus('Webhook: sent 5 jobs', 'success');
   ```
   Expected: a green status message appears below the footer. It disappears after 5 seconds.
4. Run:
   ```js
   showExtStatus('Error: webhook failed', 'error');
   ```
   Expected: red status message appears, then auto-clears after 5 seconds.
5. Click "Save Settings" — confirm existing `#save-status` still shows "Saved" in green in the footer (unaffected by this change).
6. Confirm the popup height adjusts smoothly when ext-status appears (no layout jump from fixed heights).
  </verify>
  <done>
- `#ext-status` div exists in popup.html as last child of `#app`.
- CSS styles the div as hidden (max-height: 0) by default and visible with transition when `.visible` class is added.
- `showExtStatus(message, type)` function exists in popup.js and shows green for success, red for error.
- Auto-clear fires after 5 seconds and resets className.
- `extStatus` entry exists in the `els` DOM ref object.
- Pattern comment documents the wiring approach for Phases 2-3 popup action buttons.
- Save button's existing `#save-status` / `showStatus()` is untouched.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify toast notifications and popup status display in browser</name>
  <action>Human verification step — no automated action. Tasks 1 and 2 are already complete.</action>
  <files>none</files>
  <verify>See how-to-verify below.</verify>
  <done>User confirms: toasts fire for all 4 types; master toggle suppresses them; popup ext-status shows and auto-clears; save button behavior unchanged.</done>
  <what-built>
    Task 1: fireNotification() helper in service worker, wired into handleLoadProposal for proposalLoaded and errors, with commented placeholders for future scrape/webhook handlers.
    Task 2: #ext-status div in popup.html, CSS transitions in popup.css, showExtStatus() function in popup.js.
  </what-built>
  <how-to-verify>
1. Reload the extension at chrome://extensions (click refresh icon on the extension card).

2. Toast notifications (NOTF-01):
   - Open the Service Worker DevTools (click "Service Worker" link on the extension card in chrome://extensions).
   - In the SW console run: `fireNotification('scrapeComplete', 'Test scrape notification')`
   - Expected: a Windows toast notification appears with title "Consologit_Job_Assistant" and the message text.
   - In the SW console run: `chrome.storage.local.set({'notifications.master': false}).then(() => fireNotification('scrapeComplete', 'Should NOT appear'))`
   - Expected: no notification fires.
   - Restore: `chrome.storage.local.set({'notifications.master': true})`
   - Test each type: `fireNotification('webhookSent', 'Webhook test')`, `fireNotification('proposalLoaded', 'Proposal test')`, `fireNotification('errors', 'Error test')` — all should produce toasts.

3. Popup status display (NOTF-02):
   - Open the extension popup (click toolbar icon).
   - Right-click the popup -> Inspect to open DevTools for the popup context.
   - In the popup DevTools console run: `showExtStatus('Webhook: sent 3 jobs', 'success')`
   - Expected: green status text appears below the Save button area and disappears after 5 seconds.
   - Run: `showExtStatus('Error: connection refused', 'error')`
   - Expected: red status text appears, then auto-clears.
   - Click "Save Settings" and confirm the existing "Saved" message still appears in its own area (not replaced by the new div).

4. No regressions:
   - Open the popup normally and save settings — "Saved" still appears in the footer area.
   - Navigate to a non-apply Upwork page — no console errors.
   - Navigate to an Upwork apply page — "Load Proposal" button still appears (04-01 unaffected).
  </how-to-verify>
  <resume-signal>Type "approved" to proceed, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
End-to-end verification for NOTF-01 and NOTF-02:

1. **NOTF-01 — Toast notifications respect per-type toggles:**
   - Open popup, disable "Webhook sent" checkbox, save.
   - In SW console: `fireNotification('webhookSent', 'Should be suppressed')`
   - Expected: no notification fires (per-type toggle is off).
   - Re-enable "Webhook sent", save, retry — notification fires.

2. **NOTF-01 — Master toggle suppresses all:**
   - Uncheck "Enable notifications" in popup, save.
   - Fire any notification type in SW console — none appear.
   - Re-enable master, save — notifications resume.

3. **NOTF-02 — Popup status clears automatically:**
   - `showExtStatus('Test', 'success')` appears, disappears after 5 seconds without interaction.

4. **No manifest changes required:** The `notifications` permission already exists in manifest.json from Phase 1.

5. **LOAD_PROPOSAL integration:** With n8n running and `proposalWebhookUrl` set, clicking "Load Proposal" on an apply page produces both an in-page panel (from 04-01) AND a toast notification "Proposal loaded" (from this plan).
</verification>

<success_criteria>
- NOTF-01 satisfied: chrome.notifications.create() fires after scrape, webhook push, proposal load, and error events, with per-type and master toggle gating.
- NOTF-02 satisfied: popup shows inline status messages via showExtStatus(); messages auto-clear after 5 seconds; error messages appear in red, success in green.
- fireNotification() is safe-fail — a notification failure never crashes the service worker.
- Phase 1 storage keys (notifications.master, notifications.scrapeComplete, notifications.webhookSent, notifications.proposalLoaded, notifications.errors) are read as-is with no new keys introduced.
- Existing popup save-status behavior is untouched.
- Pattern comment in popup.js guides Phases 2-3 popup action button wiring.
</success_criteria>

<output>
After completion, create `.planning/phases/04-proposal-workflow-notifications/04-02-SUMMARY.md` using the summary template at `@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md`.
</output>
