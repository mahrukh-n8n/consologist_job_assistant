---
phase: 04-proposal-workflow-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/upwork-content.js
  - src/background/service-worker.js
  - src/utils/proposal.js
autonomous: true
must_haves:
  truths:
    - "A 'Load Proposal' button appears on Upwork job apply pages (URLs matching /jobs/*/apply)"
    - "Clicking 'Load Proposal' sends job context (job ID, title, description) to service worker, which POSTs to the n8n proposal endpoint"
    - "The returned proposal text renders in a panel below the button with 'Paste' and 'Copy' buttons visible"
    - "Clicking 'Paste' inserts the proposal text into Upwork's apply description textarea"
    - "Clicking 'Copy' copies the proposal text to the clipboard via navigator.clipboard.writeText()"
    - "All operations fail silently — no uncaught exceptions crash the content script or service worker"
  artifacts:
    - path: "src/utils/proposal.js"
      provides: "ProposalManager utility — apply page detection, button injection, panel rendering, paste/copy logic"
      exports: ["ProposalManager"]
    - path: "src/content/upwork-content.js"
      provides: "Entry point that calls ProposalManager.init() on apply pages"
      contains: "ProposalManager"
    - path: "src/background/service-worker.js"
      provides: "Message handler for LOAD_PROPOSAL action — fetches from n8n proposal endpoint, returns text"
      contains: "LOAD_PROPOSAL"
  key_links:
    - from: "src/content/upwork-content.js"
      to: "src/utils/proposal.js"
      via: "import or inline inclusion"
      pattern: "ProposalManager"
    - from: "src/utils/proposal.js"
      to: "src/background/service-worker.js"
      via: "chrome.runtime.sendMessage({ action: 'LOAD_PROPOSAL', jobData })"
      pattern: "LOAD_PROPOSAL"
    - from: "src/background/service-worker.js"
      to: "n8n proposal webhook endpoint"
      via: "fetch(settings.proposalWebhookUrl, { method: 'POST', body: JSON.stringify(jobData) })"
      pattern: "proposalWebhookUrl"
    - from: "src/utils/proposal.js"
      to: "Upwork apply textarea"
      via: "document.querySelector('[data-test=\"cover-letter-text\"]') or equivalent selector"
      pattern: "cover-letter|textarea"
---

<objective>
Implement the full proposal loading workflow for Upwork job apply pages.

Purpose: When a user is on a job apply page, they need a one-click path to get an AI-generated proposal from n8n and drop it directly into the Upwork apply form — the core productivity feature of this extension.

Output: ProposalManager utility class, service worker message handler for LOAD_PROPOSAL, and wiring into the content script entry point.
</objective>

<execution_context>
@C:/Users/Glorvax/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/PROJECT.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/ROADMAP.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/STATE.md
@C:/Users/Glorvax/Documents/upwork chrome extention/.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ProposalManager utility (src/utils/proposal.js)</name>
  <files>src/utils/proposal.js</files>
  <action>
Create `src/utils/proposal.js` exposing a `ProposalManager` object. All methods must be wrapped in try/catch — failures log to console and return gracefully without throwing.

**Apply page detection:**
- `ProposalManager.isApplyPage()` — returns true if `window.location.href` matches the pattern `/jobs/[^/]+/apply` (regex: `/\/jobs\/[^/]+\/apply/`). This is the URL pattern Upwork uses for the proposal/cover-letter submission step.

**Button injection — `ProposalManager.injectButton()`:**
- Find the apply page's cover letter section. The target anchor element is the textarea with `data-test="cover-letter-text"` or `name="cover_letter"`, or fallback to any `textarea` inside a `[data-test="cover-letter-section"]` container.
- If the button is already injected (check for element with id `ext-load-proposal-btn`), return early to avoid duplicates.
- Create a `<div id="ext-proposal-wrapper">` above the textarea. Inside it, inject:
  - `<button id="ext-load-proposal-btn">Load Proposal</button>` — styled with inline CSS: `background:#14a800; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px; margin-bottom:8px;`
  - On click: disable the button, set its text to "Loading…", then call `ProposalManager.loadProposal()`.

**Job context extraction — `ProposalManager.getJobContext()`:**
- Extract job ID from the URL path (second segment after `/jobs/`).
- Extract job title from `document.title` (strip " | Upwork" suffix if present).
- Extract job description text from `[data-test="job-description"]` or `[data-test="description"]` or fallback to `document.querySelector('.job-description')`. Trim to first 2000 characters to keep the payload lean.
- Return `{ job_id, title, description }`.

**Proposal loading — `ProposalManager.loadProposal()`:**
- Call `ProposalManager.getJobContext()`.
- Send message to service worker: `chrome.runtime.sendMessage({ action: 'LOAD_PROPOSAL', jobData: context }, callback)`.
- In the callback: if `response.error`, show error state in panel. If `response.proposal`, call `ProposalManager.renderPanel(response.proposal)`. Restore button text to "Load Proposal" and re-enable it either way.

**Panel rendering — `ProposalManager.renderPanel(proposalText)`:**
- If panel with id `ext-proposal-panel` already exists, just update its `<pre>` text content and return.
- Create `<div id="ext-proposal-panel">` with inline CSS: `border:1px solid #d5d5d5; border-radius:4px; padding:12px; margin-top:8px; background:#fafafa; max-height:300px; overflow-y:auto;`
- Inside the panel:
  - `<pre id="ext-proposal-text">` with `white-space: pre-wrap; font-family: inherit; font-size: 14px; margin: 0 0 8px 0;` — set `textContent = proposalText`.
  - `<button id="ext-paste-btn">Paste into form</button>` — styled: `background:#14a800; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:8px; font-size:13px;`
  - `<button id="ext-copy-btn">Copy to clipboard</button>` — styled: `background:#fff; color:#14a800; border:1px solid #14a800; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:13px;`
- Append panel into `#ext-proposal-wrapper` (after the load button).
- Attach click handlers:
  - Paste button → `ProposalManager.pasteProposal(proposalText)`
  - Copy button → `ProposalManager.copyProposal(proposalText)`

**Paste — `ProposalManager.pasteProposal(text)`:**
- Find the cover letter textarea using the same selectors as button injection (`[data-test="cover-letter-text"]`, `[name="cover_letter"]`, fallback `textarea`).
- Set `textarea.value = text`.
- Dispatch `new Event('input', { bubbles: true })` AND `new Event('change', { bubbles: true })` — both are required to trigger React's synthetic event system so Upwork's form registers the value change.
- Set button text to "Pasted!" for 1500ms then restore to "Paste into form".

**Copy — `ProposalManager.copyProposal(text)`:**
- Call `navigator.clipboard.writeText(text)`.
- On success: set copy button text to "Copied!" for 1500ms then restore.
- On failure: log `console.error('Clipboard write failed:', err)` — do NOT throw.

**Init — `ProposalManager.init()`:**
- If `ProposalManager.isApplyPage()` is false, return immediately.
- Call `ProposalManager.injectButton()` directly.
- Also set up a `MutationObserver` on `document.body` to re-call `injectButton()` if Upwork's SPA navigation removes and re-renders the cover letter section (Upwork uses React). Debounce the observer callback to 500ms.
  </action>
  <verify>
Load the extension in Chrome (chrome://extensions, developer mode, load unpacked). Navigate to any Upwork job apply page (URL contains `/jobs/*/apply`). Confirm:
- "Load Proposal" button appears above the cover letter textarea, styled in Upwork green.
- No console errors on page load.
- Clicking the button disables it and shows "Loading…" while the message is in flight.
  </verify>
  <done>
- `src/utils/proposal.js` exists and exports `ProposalManager`.
- Button appears on apply pages only, not on search or detail pages.
- All five public methods exist: `isApplyPage`, `injectButton`, `loadProposal`, `renderPanel`, `pasteProposal`, `copyProposal`, `init`.
- No uncaught exceptions thrown — all paths are try/catch wrapped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Service worker LOAD_PROPOSAL handler + content script wiring (src/background/service-worker.js, src/content/upwork-content.js)</name>
  <files>src/background/service-worker.js, src/content/upwork-content.js</files>
  <action>
**A. Service worker — add LOAD_PROPOSAL message handler in `src/background/service-worker.js`:**

Inside the existing `chrome.runtime.onMessage.addListener` handler (from Phase 3 webhook work), add a case for `action === 'LOAD_PROPOSAL'`:

```js
if (message.action === 'LOAD_PROPOSAL') {
  handleLoadProposal(message.jobData, sendResponse);
  return true; // keep message channel open for async response
}
```

Add the `handleLoadProposal` function:
```js
async function handleLoadProposal(jobData, sendResponse) {
  try {
    const settings = await chrome.storage.local.get(['proposalWebhookUrl']);
    const url = settings.proposalWebhookUrl;

    if (!url) {
      sendResponse({ error: 'No proposal webhook URL configured. Set it in extension settings.' });
      return;
    }

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jobData)
    });

    if (!response.ok) {
      sendResponse({ error: `n8n returned ${response.status}: ${response.statusText}` });
      return;
    }

    // n8n may return plain text or JSON { proposal: "..." }
    const contentType = response.headers.get('content-type') || '';
    let proposalText;
    if (contentType.includes('application/json')) {
      const json = await response.json();
      proposalText = json.proposal || json.text || JSON.stringify(json);
    } else {
      proposalText = await response.text();
    }

    sendResponse({ proposal: proposalText.trim() });

  } catch (err) {
    sendResponse({ error: `Proposal load failed: ${err.message}` });
  }
}
```

Note: The settings key is `proposalWebhookUrl` — this is a SEPARATE setting from the job-data webhook URL (`webhookUrl`). The popup (Phase 1, out of scope here) must have an input for this. Add a comment in the handler noting this dependency so Phase 1 or the popup plan wires it up.

**B. Content script — wire ProposalManager into `src/content/upwork-content.js`:**

At the top of the file (or alongside existing script includes, depending on how Phase 1-3 structured the content script), import or inline-include `src/utils/proposal.js`. In MV3 content scripts declared in manifest.json, multi-file injection is done by listing scripts in order in the manifest `content_scripts[].js` array, NOT via ES module import (content scripts don't get module scope by default).

In the manifest `content_scripts` entry for upwork.com pages, ensure `src/utils/proposal.js` appears BEFORE `src/content/upwork-content.js` so ProposalManager is defined when the entry point runs.

In `src/content/upwork-content.js`, at the initialization block (where existing page-type detection runs), add:

```js
// Phase 4: Proposal workflow
if (typeof ProposalManager !== 'undefined') {
  ProposalManager.init();
}
```

This guard prevents a hard crash if the script load order is wrong during development.

**C. Settings key documentation comment in service-worker.js:**

At the top of `handleLoadProposal`, add:
```js
// Requires 'proposalWebhookUrl' in chrome.storage.local.
// This is distinct from 'webhookUrl' (job data webhook).
// Set via the extension popup settings panel.
```
  </action>
  <verify>
1. In Chrome DevTools on an Upwork apply page, open the Console and run:
   ```js
   chrome.runtime.sendMessage({ action: 'LOAD_PROPOSAL', jobData: { job_id: 'test', title: 'Test Job', description: 'Test desc' } }, r => console.log(r));
   ```
   Expected: response object with either `{ error: 'No proposal webhook URL configured...' }` (if URL not set) or `{ proposal: "..." }` (if n8n is running).
2. Set `proposalWebhookUrl` in storage via DevTools Console:
   ```js
   chrome.storage.local.set({ proposalWebhookUrl: 'http://localhost:5678/webhook/proposal' });
   ```
   Then click "Load Proposal" on an apply page. Confirm the panel renders with proposal text (requires n8n running) or an inline error message (if n8n is not running — this is acceptable and expected in dev).
3. Confirm `ProposalManager.init()` is called without errors on non-apply pages (should return immediately with no side effects).
  </verify>
  <done>
- Service worker handles `LOAD_PROPOSAL` messages and returns `{ proposal: string }` or `{ error: string }`.
- Content script calls `ProposalManager.init()` on every Upwork page load.
- Proposal panel renders in-page with "Paste into form" and "Copy to clipboard" buttons.
- Paste correctly populates the Upwork cover letter textarea and fires input/change events.
- Copy writes to clipboard via navigator.clipboard.writeText.
- Errors surface as inline text in the proposal panel, not as uncaught exceptions.
  </done>
</task>

</tasks>

<verification>
Full end-to-end test on a live Upwork apply page:
1. Install extension, navigate to a job on Upwork, click Apply.
2. "Load Proposal" button visible above cover letter field — styled in Upwork green (#14a800).
3. Configure `proposalWebhookUrl` in storage. With n8n running: click button, proposal text appears in panel within a few seconds.
4. Click "Paste into form" — cover letter textarea fills with proposal text. Upwork's character count updates (confirms React events fired).
5. Click "Copy to clipboard" — clipboard contains proposal text (paste into Notepad to verify).
6. Without n8n running: error message appears inside the panel, button re-enables, no console exceptions.
7. On a search page (not an apply page): no button injected, no console errors.
</verification>

<success_criteria>
- WEHK-03 satisfied: proposal text retrieved from n8n and displayed in-page.
- WEHK-04 satisfied: paste inserts into Upwork form; copy writes to clipboard.
- INJC-03 satisfied: "Load Proposal" button appears on apply pages only.
- All failure paths are silent — no thrown exceptions crash content script or service worker.
- The `proposalWebhookUrl` storage key is distinct from the job-data webhook URL and documented in code.
</success_criteria>

<output>
After completion, create `.planning/phases/04-proposal-workflow-notifications/04-01-SUMMARY.md` using the summary template at `@C:/Users/Glorvax/.claude/get-shit-done/templates/summary.md`.
</output>
